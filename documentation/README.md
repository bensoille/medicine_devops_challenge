# Medicine PubSup Specifications
## Patient / producer

### Synopsis
_Patient_ is in charge of following infinite loop :
- build a new tabs order json object
- publish this crafted order json to `tabs.orders` _Kafka_ topic
- wait `ORBITAL_ORDER_PERIOD_SECONDS` seconds

![Functional patient](assets/patient_functional.png)

> Process builds a new tabs request object periodically, frequence is configured via environment variable, at startup time

### Configuration items
The _Patient_ process accepts following **editable** configuration items, at startup time :
- `ORBITAL_PATIENT_ID` *string* :                     the unique ID of the patient who makes tab request (defaults to autogenerated uuid)
- `ORBITAL_MAX_TABS_COUNT` *integer* :                the maximum number of tabs that can be requested at once for a given patient (defaults to 30 tabs)
- `ORBITAL_ORDER_PERIOD_SECONDS` *integer* :          the time in seconds between new tabs requests (defaults to 1 second)

In addition, some internal configuration items are needed :
- kafka topic to send tabs requests/orders to
- kafka topic used for DLQ
- kafka credentials

### Tabs order factory
The _Patient_ process builds a `tabs_order` *json* representation, which contains :
- `patient_id` *string* :           the ID, or name of the patient himself, configured via environment variable
- `order_timestamp_ns` *integer* :  the date (timestamp in nanoseconds) of the original tabs order
- `tabs_count` *integer* :          the number of tabs to make for this order

### K8s Resource type
This _Patient_ process should run in a _docker_ container, orchestrated by _Kubernetes_ as a **Deployment** :
- no network access to micro service is needed so far
- process should remain running over long periods


## Medicine maker / consumer
### Synopsis
_Medicine_ is in charge of :
- (not needed when a `ScaledJob`) subscription to `tabs.orders` *Kafka* topic
- checking `tabs_order` incoming payload
- creation of as many workers as needed tabs with `ThreadPoolController`
- parallel distribution of tabs creation to each worker in `ThreadPool`
- creation of tabs, one tab as per worker in `ThreadPool`
- publishing crafted tabs json objects to `tabs.deliveries` *Kafka* topic, for subsequent delivery handling (out of scope)

![Functional medicine maker](assets/medicine_functional.png)

### K8s Resource type
This _Medicine_ process should run in a _docker_ container, orchestrated by _Kubernetes_ and `KEDA` as a **ScaledJob**, with a `Kafka` type *trigger* :
- no network access to micro service is needed so far
- process should start in a decoupled manner
- numerous jobs may be started, depending on *Patient* process activity
- process must create every tab of order in same time, and not create huge buffer needs